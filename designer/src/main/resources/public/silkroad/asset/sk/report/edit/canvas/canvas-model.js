define(["url","constant","report/component-box/components/form-config"],function(a){var b="snpt.";return Backbone.Model.extend({initialize:function(a){this.parentModel=a.parentModel,this.compBoxModel=a.compBoxModel,window.canvas=this},initJson:function(c){var d=this;$.ajax({url:a.initJson(d.id),success:function(a){if(null!==a.data)d.reportJson=JSON.parse(a.data);else{d.reportJson=$.extend(!0,{},d.compBoxModel.config.defaultJson);var e=d.compBoxModel.config.formModel;d.reportJson.entityDefs.push(e.processRenderData(b))}c(d.reportJson)}})},initVm:function(c){var d=this;$.ajax({url:a.initVm(d.id),success:function(a){if(null!==a.data)d.$reportVm=$(a.data);else{d.$reportVm=$(d.compBoxModel.config.defaultVm);var e=d.compBoxModel.config.formModel;d.$reportVm.append(e.vmTemplate.render({id:b}))}c(d.$reportVm)}})},hasFormComponent:function(){for(var a=this.reportJson.entityDefs,b=0,c=a.length;c>b;b++){var d=a[b];if("DI_FORM"===d.clzKey)return!0}return!1},_getFormJson:function(){for(var a=this.reportJson.entityDefs,b=0,c=a.length;c>b;b++){var d=a[b];if("DI_FORM"===d.clzKey)return d}return null},addComp:function(b,c,d,e){var f=this;$.ajax({url:a.addComp(f.id),type:"POST",data:{type:c},success:function(a){var g=a.data;f.addCompDataToVm(d,b,c,g),f.addCompDataToJson(b,c,g),f.saveJsonVm(e)}})},addCompDataToVm:function(a,c,d,e){var f=b+e.id,g=a(e.id,f);g.html('<div style="width:100%; height:20px"></div>'+c.vm.render({rootId:b,serverData:e})),this.$reportVm.append(g)},addCompDataToJson:function(a,c,d){var e,f=this.reportJson;if(e=a.processRenderData({rootId:b,serverData:d}),$.isArray(e))for(var g=0,h=e.length;h>g;g++)e[g].compId=d.id;else e.compId=d.id;var i=f.entityDefs;a.entityDescription&&!$.isArray(a.entityDescription)&&"VUI"==a.entityDescription.clzType&&(formJson=this._getFormJson(),formJson.vuiRef.input.push(e.id)),this.reportJson.entityDefs=i.concat(e)},deleteComp:function(b,c,d){var e=this;$.ajax({url:a.deleteComp(e.id,b),type:"DELETE",success:function(){e._deleteComp(b,c,d)}})},_deleteComp:function(a,b,c){var d=this,e=!1;c=c||new Function;var f="[data-comp-id="+a+"]";d.$reportVm.find(f).remove();for(var g=d.reportJson.entityDefs,h=0;h<g.length;h++)if(g[h].compId==a&&("VUI"!=g[h].clzType||"X_CALENDAR"!=g[h].clzKey&&"ECUI_SELECT"!=g[h].clzKey&&"ECUI_MULTI_SELECT"!=g[h].clzKey||(d._deleteCompFromForm(g[h].id),e=!0),g.splice(h,1),h--),"COMPONENT"===g[h].clzType&&g[h].interactions)for(var i=0,j=g[h].interactions.length;j>i;i++){var k=g[h].interactions[i];if(k.event&&k.event.rid===b)g[h].interactions.splice(i,1);else if(k.events)for(var l=0,m=k.events.length;m>l;l++)k.events[l].rid===b&&k.events.splice(l,1)}d.saveJsonVm(c)},_processFrom:function(){var a=this._getFormJson(),b=a.vuiRef.input;0==b.length&&this._deleteComp("comp-id-form"),this._responseFormChange()},_deleteCompFromForm:function(a){for(var b=this._getFormJson(),c=b.vuiRef.input,d=0,e=c.length;e>d;d++)if(c[d]==a){c.splice(d,1);break}},updateCompPositing:function(a,b,c){this.$reportVm.find("[data-comp-id="+a+"]").css({left:b,top:c}),this.saveJsonVm()},dateCompPositing:function(a,b){var c=this.$reportVm.find("[id="+a+"]");c.attr("id")==a&&c.html(b),this.saveJsonVm()},resizeComp:function(a){this.$reportVm.find("[data-comp-id="+a.compId+"]").css({width:a.width,height:a.height}).find(".vu-table").height(parseInt(a.height)-130),this.saveJsonVm()},saveReport:function(b){var c=this;$.ajax({url:a.saveReport(c.id),type:"PUT",data:{json:JSON.stringify(c.reportJson),vm:c.$reportVm.prop("outerHTML")},success:function(){b&&b()}})},saveJsonVm:function(b){var c=this;b=b||new Function,$.ajax({url:a.saveJsonVm(c.id),type:"PUT",data:{json:JSON.stringify(c.reportJson),vm:c.$reportVm.prop("outerHTML")},success:function(){b()}})}})});