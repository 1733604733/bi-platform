define(["url","constant","report/component-box/components/form-config"],function(a,b){var c="snpt.";return Backbone.Model.extend({initialize:function(a){this.parentModel=a.parentModel,this.compBoxModel=a.compBoxModel,window.canvas=this},initJson:function(b){var d=this;$.ajax({url:a.initJson(d.id),success:function(a){if(null!==a.data)d.reportJson=JSON.parse(a.data);else{d.reportJson=$.extend(!0,{},d.compBoxModel.config.defaultJson);var e=d.compBoxModel.config.formModel;d.reportJson.entityDefs.push(e.processRenderData(c))}b(d.reportJson)}})},initVm:function(b){var d=this;$.ajax({url:a.initVm(d.id),success:function(a){if(null!==a.data)d.$reportVm=$(a.data);else{d.$reportVm=$(d.compBoxModel.config.defaultVm);var e=d.compBoxModel.config.formModel;d.$reportVm.append(e.vmTemplate.render({id:c}))}b(d.$reportVm)}})},hasFormComponent:function(){for(var a=this.reportJson.entityDefs,b=0,c=a.length;c>b;b++){var d=a[b];if("DI_FORM"===d.clzKey)return!0}return!1},_getFormJson:function(){for(var a=this.reportJson.entityDefs,b=0,c=a.length;c>b;b++){var d=a[b];if("DI_FORM"===d.clzKey)return d}return null},addComp:function(b,c,d,e){var f=this;$.ajax({url:a.addComp(f.id),type:"POST",data:{type:c},success:function(a){var g=a.data;f.addCompDataToVm(d,b,c,g),f.addCompDataToJson(b,c,g),f.saveJsonVm(e)}})},addCompDataToVm:function(a,b,d,e){var f=c+e.id,g=a(e.id,f);g.html(b.vm.render({rootId:c,serverData:e})),this.$reportVm.append(g)},addCompDataToJson:function(a,b,d){for(var e,f=this.reportJson,g=!1,h=!1,i=f.entityDefs,j=0;j<i.length;j++)"COMPONENT"===i[j].clzType&&"DI_FORM"===i[j].clzType&&i[j].vuiRef&&i[j].vuiRef.confirm&&(h=!0);if(e=a.processRenderData({rootId:c,serverData:d}),h&&e.dataOpt&&(e.dataOpt.submitMode="CONFIRM"),$.isArray(e))for(var j=0,k=e.length;k>j;j++)e[j].compId=d.id;else e.compId=d.id;if(a.entityDescription&&!$.isArray(a.entityDescription)&&"VUI"==a.entityDescription.clzType&&(formJson=this._getFormJson(),"H_BUTTON"===a.entityDescription.clzKey?(formJson.vuiRef.confirm=e.id,g=!0):formJson.vuiRef.input.push(e.id)),g)for(var j=0;j<i.length;j++)"COMPONENT"===i[j].clzType&&i[j].dataOpt&&i[j].dataOpt.submitMode&&(i[j].dataOpt.submitMode="CONFIRM");this.reportJson.entityDefs=i.concat(e)},deleteComp:function(b,c,d){var e=this;$.ajax({url:a.deleteComp(e.id,b),type:"DELETE",success:function(){e._deleteComp(b,c,d)}})},_deleteComp:function(a,c,d){var e=this,f=!1,g=!1;d=d||new Function;var h="[data-comp-id="+a+"]";e.$reportVm.find(h).remove();for(var i=e.reportJson.entityDefs,j=0;j<i.length;j++){if(i[j].compId==a){if("VUI"==i[j].clzType&&$.isInArray(i[j].clzKey,b.FORM_VUI_REF)&&(e._deleteCompFromForm(i[j].id),f=!0),"VUI"==i[j].clzType&&"H_BUTTON"===i[j].clzKey&&i[j].dataOpt&&"查询"===i[j].dataOpt.text){var k=e._getFormJson();k.vuiRef.confirm=null,delete k.vuiRef.confirm,f=!0,g=!0}i.splice(j,1),j--}if("COMPONENT"===i[j].clzType&&i[j].interactions)for(var l=0,m=i[j].interactions.length;m>l;l++){var n=i[j].interactions[l];if(n.event&&n.event.rid===c)i[j].interactions.splice(l,1);else if(n.events)for(var o=0,p=n.events.length;p>o;o++)n.events[o].rid===c&&n.events.splice(o,1)}}if(g)for(var j=0;j<i.length;j++)"COMPONENT"===i[j].clzType&&i[j].dataOpt&&i[j].dataOpt.submitMode&&(i[j].dataOpt.submitMode="IMMEDIATE");e.saveJsonVm(d)},_processFrom:function(){var a=this._getFormJson(),b=a.vuiRef.input;0==b.length&&this._deleteComp("comp-id-form"),this._responseFormChange()},_deleteCompFromForm:function(a){for(var b=this._getFormJson(),c=b.vuiRef.input,d=0,e=c.length;e>d;d++)if(c[d]==a){c.splice(d,1);break}},updateCompPositing:function(a,b,c){this.$reportVm.find("[data-comp-id="+a+"]").css({left:b,top:c}),this.saveJsonVm()},dateCompPositing:function(a,b){var c=this.$reportVm.find("[id="+a+"]");c.attr("id")==a&&c.html(b),this.saveJsonVm()},resizeComp:function(a){this.$reportVm.find("[data-comp-id="+a.compId+"]").css({width:a.width,height:a.height}).find(".vu-table").height(parseInt(a.height)-77),this.saveJsonVm()},saveReport:function(b,c,d){var e=this;$.ajax({url:a.saveReport(e.id),type:"PUT",data:{json:JSON.stringify(e.reportJson),vm:e.$reportVm.prop("outerHTML")},success:function(a){if(0===a.status)c&&c();else{var e=a.statusInfo;d&&d(e,b)}}})},saveJsonVm:function(b){var c=this;b=b||new Function,$.ajax({url:a.saveJsonVm(c.id),type:"PUT",data:{json:JSON.stringify(c.reportJson),vm:c.$reportVm.prop("outerHTML")},success:function(){b()}})},saveEditReportName:function(b,c){$.ajax({type:"POST",dataType:"json",cache:!1,timeout:1e4,uri:a.saveEditReportName(b,c),success:function(a){0===a.status?dialog.success(a.statusInfo):dialog.error(a.statusInfo)}})}})});