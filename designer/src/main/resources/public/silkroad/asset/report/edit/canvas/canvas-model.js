define(["url","report/component-box/components/form-config"],function(a){var b="snpt.";return Backbone.Model.extend({initialize:function(a){this.parentModel=a.parentModel,this.compBoxModel=a.compBoxModel,window.canvas=this},initJson:function(c){var d=this;$.ajax({url:a.initJson(d.id),success:function(a){if(null!==a.data)d.reportJson=JSON.parse(a.data);else{d.reportJson=$.extend(!0,{},d.compBoxModel.config.defaultJson);var e=d.compBoxModel.config.formModel;d.reportJson.entityDefs.push(e.processRenderData(b))}c(d.reportJson)}})},initVm:function(c){var d=this;$.ajax({url:a.initVm(d.id),success:function(a){if(null!==a.data)d.$reportVm=$(a.data);else{d.$reportVm=$(d.compBoxModel.config.defaultVm);var e=d.compBoxModel.config.formModel;d.$reportVm.append(e.vmTemplate.render({id:b}))}c(d.$reportVm)}})},hasFormComponent:function(){for(var a=this.reportJson.entityDefs,b=0,c=a.length;c>b;b++){var d=a[b];if("DI_FORM"===d.clzKey)return!0}return!1},_getFormJson:function(){for(var a=this.reportJson.entityDefs,b=0,c=a.length;c>b;b++){var d=a[b];if("DI_FORM"===d.clzKey)return d}return null},addComp:function(b,c,d,e){var f=this;$.ajax({url:a.addComp(f.id),type:"POST",data:{type:c},success:function(a){var g=a.data;f.addCompDataToVm(d,b,c,g),f.addCompDataToJson(b,c,g),f.saveJsonVm(e)}})},addCompDataToVm:function(a,c,d,e){var f=a(e.id);f.html(c.vm.render({rootId:b,serverData:e})),this.$reportVm.append(f)},addCompDataToJson:function(a,c,d){var e,f=this.reportJson;if(e=a.processRenderData({rootId:b,serverData:d}),$.isArray(e))for(var g=0,h=e.length;h>g;g++)e[g].compId=d.id;else e.compId=d.id;var i=f.entityDefs;a.entityDescription&&!$.isArray(a.entityDescription)&&"VUI"==a.entityDescription.clzType&&(formJson=this._getFormJson(),formJson.vuiRef.input.push(e.id)),this.reportJson.entityDefs=i.concat(e)},deleteComp:function(b,c){var d=this;$.ajax({url:a.deleteComp(d.id,b),type:"DELETE",success:function(){d._deleteComp(b,c)}})},_deleteComp:function(a,b){var c=this,d=!1;b=b||new Function;var e="[data-comp-id="+a+"]";c.$reportVm.find(e).remove();for(var f=c.reportJson.entityDefs,g=0;g<f.length;g++)f[g].compId==a&&("VUI"!=f[g].clzType||"X_CALENDAR"!=f[g].clzKey&&"ECUI_SELECT"!=f[g].clzKey||(c._deleteCompFromForm(f[g].id),d=!0),f.splice(g,1),g--);c.saveJsonVm(b)},_processFrom:function(){var a=this._getFormJson(),b=a.vuiRef.input;0==b.length&&this._deleteComp("comp-id-form"),this._responseFormChange()},_deleteCompFromForm:function(a){for(var b=this._getFormJson(),c=b.vuiRef.input,d=0,e=c.length;e>d;d++)if(c[d]==a){c.splice(d,1);break}},updateCompPositing:function(a,b,c){this.$reportVm.find("[data-comp-id="+a+"]").css({left:b,top:c}),this.saveJsonVm()},resizeComp:function(a){this.$reportVm.find("[data-comp-id="+a.compId+"]").css({width:a.width,height:a.height}).find(".vu-table").height(parseInt(a.height)-130),this.saveJsonVm()},saveReport:function(b){var c=this;$.ajax({url:a.saveReport(c.id),type:"PUT",data:{json:JSON.stringify(c.reportJson),vm:c.$reportVm.prop("outerHTML")},success:function(){b&&b()}})},saveJsonVm:function(b){var c=this;b=b||new Function,$.ajax({url:a.saveJsonVm(c.id),type:"PUT",data:{json:JSON.stringify(c.reportJson),vm:c.$reportVm.prop("outerHTML")},success:function(){b()}})}})});