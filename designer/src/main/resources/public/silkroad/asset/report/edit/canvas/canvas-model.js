define(["url","report/edit/component-box/form-model"],function(Url,formModel){var rootId="snpt.";return Backbone.Model.extend({initialize:function(a){this.parentModel=a.parentModel,this.compBoxModel=a.compBoxModel,window.canvas=this},initJson:function(success){var that=this;$.ajax({url:Url.initJson(that.id),success:function(data){if(null!==data.data)that.reportJson=eval("("+data.data+")");else{that.reportJson=that.compBoxModel.config.defaultJson;var formModel=that.compBoxModel.config.formModel;that.reportJson.entityDefs.push(formModel.processRenderData(rootId))}success(that.reportJson)}})},initVm:function(a){var b=this;$.ajax({url:Url.initVm(b.id),success:function(c){if(null!==c.data)b.$reportVm=$(c.data);else{b.$reportVm=$(b.compBoxModel.config.defaultVm);var d=b.compBoxModel.config.formModel;b.$reportVm.append(d.vmTemplate.render({id:rootId}))}a(b.$reportVm)}})},hasFormComponent:function(){for(var a=this.reportJson.entityDefs,b=0,c=a.length;c>b;b++){var d=a[b];if("DI_FORM"===d.clzKey)return!0}return!1},_getFormJson:function(){for(var a=this.reportJson.entityDefs,b=0,c=a.length;c>b;b++){var d=a[b];if("DI_FORM"===d.clzKey)return d}return null},addComp:function(a,b,c,d){var e=this;$.ajax({url:Url.addComp(e.id),type:"POST",data:{type:b},success:function(f){var g=f.data;e.addCompDataToVm(c,a,b,g),e.addCompDataToJson(a,b,g),e.saveJsonVm(d)}})},addCompDataToVm:function(a,b,c,d){var e=a(d.id);e.html(b.vm.render({rootId:rootId,serverData:d})),this.$reportVm.append(e)},addCompDataToJson:function(a,b,c){var d,e=this.reportJson;d=a.processRenderData({rootId:rootId,serverData:c});for(var f=0,g=d.length;g>f;f++)d[f].compId=c.id;var h=e.entityDefs;"vui"==a.componentType&&(formJson=this._getFormJson(),formJson.vuiRef.input.push(d[0].id)),this.reportJson.entityDefs=h.concat(d)},deleteComp:function(a,b){var c=this;$.ajax({url:Url.deleteComp(c.id,a),type:"DELETE",success:function(){c._deleteComp(a,b)}})},_deleteComp:function(a,b){var c=this,d=!1;b=b||new Function;var e="[data-comp-id="+a+"]";c.$reportVm.find(e).remove();for(var f=c.reportJson.entityDefs,g=0;g<f.length;g++)f[g].compId==a&&("VUI"==f[g].clzType&&"X_CALENDAR"==f[g].clzKey&&(c._deleteCompFromForm(f[g].id),d=!0),f.splice(g,1),g--);c.saveJsonVm(b)},_processFrom:function(){var a=this._getFormJson(),b=a.vuiRef.input;0==b.length&&this._deleteComp("comp-id-form"),this._responseFormChange()},_deleteCompFromForm:function(a){for(var b=this._getFormJson(),c=b.vuiRef.input,d=0,e=c.length;e>d;d++)if(c[d]==a){c.splice(d,1);break}},updateCompPositing:function(a,b,c){this.$reportVm.find("[data-comp-id="+a+"]").css({left:b,top:c}),this.saveJsonVm()},resizeComp:function(a){this.$reportVm.find("[data-comp-id="+a.compId+"]").css({width:a.width,height:a.height}).find(".vu-table").height(parseInt(a.height)-130),this.saveJsonVm()},saveReport:function(a){var b=this;$.ajax({url:Url.saveReport(b.id),type:"PUT",data:{json:JSON.stringify(b.reportJson),vm:b.$reportVm.prop("outerHTML")},success:function(){a&&a()}})},saveJsonVm:function(a){var b=this;a=a||new Function,$.ajax({url:Url.saveJsonVm(b.id),type:"PUT",data:{json:JSON.stringify(b.reportJson),vm:b.$reportVm.prop("outerHTML")},success:function(){a()}})}})});