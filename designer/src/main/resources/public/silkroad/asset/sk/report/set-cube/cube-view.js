define(["template","dialog","report/set-cube/cube-model","report/set-cube/main-template","report/set-cube/cube-list-template"],function(a,b,c,d,e){return Backbone.View.extend({events:{"click .j-root-data-sources-list .j-item":"loadFactTableList","click .j-con-cube-list .j-item":"selectCubes","click .j-root-set-group .j-set-group":"addFormLine","click .j-root-set-group .j-delete":"deleteFormLine","click .j-create-data-sources-link":"enterCreateDataSources","click .j-submit":"submit","click .j-cancel":"cancel","change .j-select-area-date":"changeDateArea"},initialize:function(a){var b=this;this.model=new c({id:this.id}),this.listenTo(this.model,"change:activeDataSourcesList",function(a,c){var e=d.render({dataSourcesList:c});b.$el.html(e)}),this.listenTo(this.model,"change:factTableList",function(a,c){var d=b.model.get("separateTableRuleData");c.separateTableRuleData=d;var f=e.render(c);b.$el.find(".j-con-cube-list").html(f)}),this.listenTo(this.model,"change:selectedTable",function(a,b){var c=".j-root-set-group .j-select-table",d=this.$el.find(c);if(d.length){var e=[];$.each(b,function(){e.push('<option value="',this.id,'">',this.text,"</option>")}),d.each(function(){$(this).html(e.join(""))})}}),a.edit===!0?b.model.loadSelectedDataSources(function(a){b.model.dataSourcesModel.loadDsGroupActive(function(){b.model.loadFactTableList(a,!0)})}):b.model.dataSourcesModel.loadDsGroupActive(),window.dataInsight.main=this},loadFactTableList:function(a){var b=$(a.target),c=b.attr("data-id"),d=".j-root-data-sources-list .j-item.selected";this.$el.find(d).removeClass("selected"),b.addClass("selected"),this.model.selectedDsId=c;var e=$("span[data-id="+c+"]").attr("group-id");this.model.loadFactTableList(e)},selectCubes:function(a){var b,c=$(a.target),d=[];c.hasClass("selected")?c.removeClass("selected"):c.addClass("selected"),$(".j-root-set-group .j-regexps-validate").text("").hide(),b=this.$el.find(".j-con-cube-list .j-item.selected"),b.each(function(){var a=$(this).attr("data-id"),b=$(this).text();d.push({id:a,text:b})}),this.model.set("selectedTable",d)},addFormLine:function(a){$(a.target);var b=".j-root-set-group-template",c=this.$el.find(b).clone();b=".j-con-cube-list .j-item.selected";var d=this.$el.find(b);b=".j-root-set-group .j-select-table";var e=this.$el.find(b);if(!d.length)return $(".j-root-set-group .j-regexps-validate").text("提示：请先选择表格").show(),void 0;if(d.length<=e.length)return $(".j-root-set-group .j-regexps-validate").text("提示：不能再添加规则").show(),void 0;var f=[];d.each(function(){f.push('<option value="',$(this).attr("data-id"),'">',$(this).text(),"</option>")}),c.find(".j-select-table").html(f.join(""));var g=c.removeClass("hide j-root-set-group-template");$(".j-regexps-validate").before(g.addClass("j-regexps-item"))},deleteFormLine:function(a){var b=$(a.target);b.parents(".j-regexps-item").remove()},enterCreateDataSources:function(){require(["data-sources/create-view"],function(a){new a({el:$(".j-main"),isAdd:!0})})},changeDateArea:function(a){for(var b=$(a.target),c=b.val().toLowerCase(),d=[],e=this.model.get("separateTableRuleData"),f=e[c].children,g=0,h=f.length;h>g;g++)d.push('<option value="',f[g].value,'">',f[g].text,"</option>");b.next("select").html(d.join(""))},submit:function(){var a=this,c=".j-con-cube-list .j-item.selected",d=this.$el.find(c),e=this.$el.find(".j-root-set-group .j-regexps-item"),f={};if(0==d.length)return b.error("至少需要选择一个实体表作为cube"),void 0;c=".j-root-data-sources-list .j-item.selected",f.dataSourceId=this.$el.find(c).attr("group-id"),f.selectedTables=[],d.each(function(){f.selectedTables.push($(this).text())}),f.selectedTables=f.selectedTables.join(",");var g={},h={},i=!1;return e.each(function(){var a=$(this).find("select"),b=$(this).find("input").val().trim(),c=$(a[0]).val(),d=$(a[1]).val(),e=$(a[2]).val();return h[c]?(i=!0,void 0):(h[c]=!0,g[c]={type:d,prefix:b,condition:e},void 0)}),i?($(".j-root-set-group .j-regexps-validate").text("提示：表格不能重复").show(),void 0):(f.regexps=JSON.stringify(g),this.model.submit(f,function(){window.dataInsight.main.destroy(),require(["report/dim-set/view"],function(b){new b({el:$(".j-main"),id:a.id})})}),void 0)},cancel:function(){window.dataInsight.main.destroy(),require(["report/list/main-view"],function(a){new a({el:$(".j-main")})})},destroy:function(){this.model.clear({silent:!0}),this.stopListening(),this.$el.unbind().empty()}})});