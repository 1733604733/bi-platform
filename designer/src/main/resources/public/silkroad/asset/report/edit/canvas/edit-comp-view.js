define(["template","dialog","constant","report/edit/canvas/edit-comp-model","report/edit/canvas/comp-setting-default-template","report/edit/canvas/comp-setting-time-template","report/edit/canvas/comp-setting-liteolap-template","report/edit/canvas/comp-setting-chart-template","report/edit/canvas/vui-setting-select-template","report/edit/canvas/default-selected-time-setting-template","report/edit/canvas/data-format-setting-template","report/edit/canvas/topn-setting-template","common/float-window","report/edit/canvas/chart-icon-list-template","report/edit/canvas/norm-info-depict-template","report/edit/canvas/filter-blank-line-template"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){function q(a,b){var c=a.oLapElementId,d="[data-id="+c+"]",e=b.find(d);if(1==e.length){d="ind"==a.oLapElemenType?".j-line-cand-ind":".j-line-cand-dim";var f=a.$item.clone();f.find(".j-delete").remove(),b.find(d).append(f)}else if(2==e.length){var g=e.eq(1).find(".j-delete");1==g.length&&g.remove()}}return Backbone.View.extend({events:{"click .j-comp-setting .j-delete":"deleteCompAxis","click .j-report":"removeCompEditBar","click .j-set-default-time":"openTimeSettingDialog","click .j-set-data-format":"getDataFormatList","click .j-set-topn":"getTopnList","click .j-norm-info-depict":"getNormInfoDepict","click .item .j-icon-chart":"showChartList","click .j-others-operate":"getFilterBlankLine","change .select-type":"selectTypeChange"},selectTypeChange:function(a){var b=$(a.target).val(),c=this.model.canvasModel.reportJson.entityDefs;this.canvasView._component.dispose();for(var d=0,e=c.length;e>d;d++)("ECUI_SELECT"===c[d].clzKey||"ECUI_MULTI_SELECT"===c[d].clzKey)&&(c[d].clzKey=b);this.canvasView.model.$reportVm.find("[data-component-type=SELECT]").attr("data-mold",b),this.model.canvasModel.saveJsonVm(this.canvasView.showReport.call(this.canvasView))},initialize:function(a){this.model=new d({canvasModel:a.canvasView.model,reportId:a.reportId}),this.canvasView=a.canvasView,this.$conCompSetting=this.$el.find(".j-con-comp-setting")},initCompConfigBar:function(a){var b=this,c=$(a.target),d=c.parents(".j-component-item"),e=d.attr("data-comp-id"),f=d.attr("data-component-type"),g=d.attr("data-mold");b.model.compId=e,b.model.compType=f,b.hideEditBar(),b.model.getCompAxis(e,function(a){a.compId=e;var c=b._adapterEditCompTemplate(f);a.compType=f,g&&(a.compMold=g);var h=c.render(a);b.$el.find(".j-con-comp-setting").html(h),b.initLineAccept(f),d.addClass("active").mouseout(),b.initSortingItem(),b.canvasView.parentView.ueView.setSize()})},_adapterEditCompTemplate:function(a){var b;switch(a){case"TIME_COMP":b=f;break;case"LITEOLAP":b=g;break;case"CHART":b=h;break;case"SELECT":b=i;break;default:b=e}return b},initLineAccept:function(a){var b,c=this,d=".j-olap-element",e=".j-time-dim";switch(a){case"TIME_COMP":b=e;break;case"LITEOLAP":b=d;break;default:b=d}$(".j-comp-setting-line",this.el).droppable({accept:b,drop:function(b,d){var e=$(this);c.addCompAxis(d,e,a),e.removeClass("active")},out:function(){$(this).removeClass("active")},over:function(){$(this).addClass("active")},helper:"clone"})},initSortingItem:function(){var a=this,b={};$(".j-line-x,.j-line-y",this.el).sortable({items:".j-root-line,.j-cal-ind,.j-group-title",axis:"x",start:function(a,c){c.placeholder.height(0),b.source=c.item.parent().find("[data-id]").index(c.item)},stop:function(c,d){var e=d.item.parent(),f=e.parent().attr("data-comp-id");b.target=e.find("[data-id]").index(d.item),b.type=e.attr("data-axis-type"),b.source!=b.target&&a.model.sortingCompDataItem(f,b,function(){a.canvasView.showReport()})}})},deleteCompAxis:function(a){var b,c,d=this,e=$(a.target);b=".j-comp-setting";var f=e.parents(b),g=f.attr("data-comp-id"),h=f.attr("data-comp-type");b=".j-comp-setting-line",c="data-axis-type";var i=e.parents(b).attr(c);c="data-id";var j=e.parent().attr(c);d.model.deleteCompAxis(g,i,j,function(){var a=e.parent(),b=a.attr("data-id");if(e.parent().remove(),d.afterDeleteCompAxis({oLapElementId:b,compType:h,axisType:i,$item:e.parent()}),d.canvasView.showReport(),0==d.$el.find("[data-id="+b+"]").length){var c=" .j-root-line[data-id="+b+"]";$(".j-con-org-ind"+c).addClass("j-can-to-dim"),$(".j-con-org-dim"+c).addClass("j-can-to-ind")}})},afterDeleteCompAxis:function(a){if(void 0!==a.compType){var b=this._switchCompTypeWord(a.compType);this["afterDelete"+b+"CompAxis"](a)}},afterDeleteLiteOlapCompAxis:function(a){var b=this,c=b.$el.find(".j-comp-setting"),d=a.axisType;"xys".indexOf(d)>-1;var e="[data-id="+a.oLapElementId+"]",f=c.find(e);e=".j-delete";var g='<span class="icon-letter j-delete">×</span>';1==f.length&&0==f.find(e).length&&f.append(g)},afterDeleteTimeCompAxis:function(a){for(var b=this.model.canvasModel.compBoxModel,c=b.getComponentData("TIME_COMP"),d=this.getActiveCompId(),e=this.canvasView.editCompView.model,f=e.getCompDataById(d)[0],g=a.$item.attr("data-name"),h=c.switchLetter(g),i=f.dataSetOpt.timeTypeList,j=0,k=i.length;k>j;j++)if(h==i[j].value){i.splice(j,1);break}delete f.dataSetOpt.timeTypeOpt[h],delete f.dateKey[h],this.model.canvasModel.saveReport()},afterDeleteChartCompAxis:function(){},afterDeleteTableCompAxis:function(){},afterDeleteSelectCompAxis:function(){},addCompAxis:function(a,c){var d,e,f,g=a.helper,h=this,i=b.alert;d=".j-comp-setting";var j=c.parents(d),k=j.attr("data-comp-id"),l=j.attr("data-comp-type"),m=g.clone().attr("style","");if("SELECT"===l&&$(".data-axis-line .item").length>=1)return i("只能拖一个维度或者维度组"),void 0;var n=m.find("span");m.hasClass("j-group-title")?m.addClass("item"):n.eq(1).remove(),a.draggable.removeClass("j-can-to-dim j-can-to-ind"),d=".j-data-sources-setting-con-ind",f=a.draggable.parents(d),f=f.length?"ind":"dim",h._addDimOrIndDomToXY(m,f,l),e=h.canvasView.parentView.model.get("currentCubeId");var o={cubeId:e,oLapElementId:m.attr("data-id"),axisType:c.attr("data-axis-type")};m.removeClass("j-olap-element").addClass("c-m"),h.model.addCompAxis(k,o,function(){m.removeClass("j-time-dim"),c.append(m),h.afterAddCompAxis({compType:l,oLapElemenType:f,oLapElementId:o.oLapElementId,axisType:o.axisType,$item:m}),h.canvasView.showReport(),h.canvasView.parentView.ueView.setSize()})},_addDimOrIndDomToXY:function(a,b,c){var d;"ind"===b&&"CHART"===c&&(d='<span class="icon-chart column j-icon-chart" chart-type="column" ></span>',a.prepend(d)),d='<span class="icon hide j-delete" title="删除">×</span>',a.append(d),$(a.find(".j-item-text")).removeClass("ellipsis").addClass("icon-font")},showChartList:function(a){b.alert;var d=this,e=$(a.target),f=".j-comp-setting",g=e.parents(f),h=g.attr("data-comp-id"),i=e.parent().attr("data-id"),j=e.attr("chart-type"),k=c.CHART_TYPES;for(var l in k)k[l]=!1;k[j]=!0,d.chartList?d.chartList.redraw(n.render(k)):d.chartList=new m({direction:"vertical",content:n.render(k)}),$(".comp-setting-charticons span").unbind(),$(".comp-setting-charticons span").click(function(){var a=$(this),b=a.attr("chart-type");e.parent().siblings("div"),d.model.changeCompItemChartType(h,i,b,function(){e.removeClass(j).addClass(b),e.attr("chart-type",b),d.chartList.hide(),d.canvasView.showReport()})}),d.chartList.show($(a.target).parent())},afterAddCompAxis:function(a){if(void 0!==a.compType){var b=this._switchCompTypeWord(a.compType);this["afterAdd"+b+"CompAxis"](a)}},afterAddLiteOlapCompAxis:function(a){var b=this,c=b.$el.find(".j-comp-setting"),d="xys".indexOf(a.axisType)>-1;d&&q(a,c)},afterAddChartCompAxis:function(a){var b=this,c=b.$el.find(".j-comp-setting"),d="xys".indexOf(a.axisType)>-1;d&&q(a,c)},afterAddSelectCompAxis:function(a){var b=this.getActiveCompId(),c=this.canvasView.editCompView.model,d=c.getCompDataById(b)[0],e=a.$item.attr("data-id");d.dimId=e,this.model.canvasModel.saveJsonVm()},afterAddMultiSelectCompAxis:function(a){var b=this.getActiveCompId(),c=this.canvasView.editCompView.model,d=c.getCompDataById(b)[0],e=a.$item.attr("data-id");d.dimId=e,this.model.canvasModel.saveJsonVm()},afterAddTableCompAxis:function(){},afterAddTimeCompAxis:function(a){var b,c,d=this.model.canvasModel.compBoxModel,e=d.getComponentData("TIME_COMP"),f=this.getActiveCompId(),g=this.canvasView.editCompView.model,h=g.getCompDataById(f)[0],i=a.$item.attr("data-name"),j=a.$item.attr("data-id"),k=e.timeTypeConfig,l=e.switchLetter(i);b=k.timeTypeList[l],c=k.timeTypeOpt[l],h.dataSetOpt.timeTypeList.push(b),h.dataSetOpt.timeTypeOpt[l]=c,h.dateKey[l]=j,h.name=h.dateKey[h.dataSetOpt.timeTypeList[0].value],this.model.canvasModel.saveJsonVm(),this.model.canvasModel.saveReport()},_switchCompTypeWord:function(a){var b;switch(a){case"LITEOLAP":b="LiteOlap";break;case"TIME_COMP":b="Time";break;case"CHART":b="Chart";break;case"SELECT":b="Select";break;case"MULTISELECT":b="MultiSelect";break;case"TABLE":b="Table"}return b},_getEditBarAndActiveComp:function(){var a,b,c=this.$el.find(".j-comp-setting"),d={};return 0===c.length?d:(d.$compSetting=c,a=c.attr("data-comp-id"),b=".j-component-item[data-comp-id="+a+"]",d.$activeComp=this.$el.find(b),d)},hideEditBar:function(){var a=this._getEditBarAndActiveComp();void 0!==a.$compSetting&&a.$compSetting.remove(),void 0!==a.$activeComp&&a.$activeComp.removeClass("active"),this.canvasView.parentView.ueView.setSize()},activeComp:function(){var a=this._getEditBarAndActiveComp();void 0!==a.$activeComp&&a.$activeComp.addClass("active")},removeCompEditBar:function(a){var b=this;$(a.target).parent().hasClass("j-report")&&b.hideEditBar()},openTimeSettingDialog:function(){function a(a){var b=[],c=a.find(".j-item");return c.each(function(){var a={},c=$(this),d=c.attr("data-type"),e=c.find("select").val(),f=c.find("input").val();a.type=d,a.date=[f+e],b.push(a)}),b}var c=this,d=c.model.canvasModel.compBoxModel,e=c.getActiveCompId(),f=c.model.getCompDataById(e),g=d.getComponentData("TIME_COMP").deSwitchConfig,h=g(f[0].dataSetOpt.timeTypeOpt),i=j.render({list:h});b.showDialog({title:"默认选中时间设置",content:i,dialog:{width:300,height:249,open:function(){},buttons:[{text:"提交",click:function(){var b=$(this),d=a(b);c.model.updateCalendarJson(d,function(){b.dialog("close"),c.canvasView.showReport()})}},{text:"取消",click:function(){$(this).dialog("close")}}]}})},getDataFormatList:function(){function a(a){var d;return a?(d=k.render(a),b.showDialog({title:"数据格式",content:d,dialog:{width:340,height:300,resizable:!1,buttons:[{text:"提交",click:function(){c($(this))}},{text:"取消",click:function(){$(this).dialog("close")}}]}}),void 0):(b.alert("没有指标"),void 0)}function c(a){var b=$(".data-format").find("select"),c={};b.each(function(){var a=$(this),b=a.attr("name");c[b]=a.val()}),d.model.saveDataFormatInfo(e,c,function(){a.dialog("close"),d.canvasView.showReport()})}var d=this,e=d.getActiveCompId();d.model.getDataFormatList(e,a)},getTopnList:function(){function a(a){var d;return a.indList?(d=l.render(a),b.showDialog({title:"topn设置",content:d,dialog:{width:340,height:400,resizable:!1,buttons:[{text:"提交",click:function(){c($(this))}},{text:"取消",click:function(){$(this).dialog("close")}}]}}),void 0):(b.alert("没有指标"),void 0)}function c(a){var b=$(".topn-indlist").find("select"),c=$(".topn-indlist").find("input"),f={};b.each(function(){var a=$(this),b=a.attr("name");f[b]=a.val()}),f[c.attr("name")]=c.val(),d.model.saveTopnInfo(e,f,function(){a.dialog("close"),d.canvasView.showReport()})}var d=this,e=d.getActiveCompId();d.model.getTopnList(e,a)},getNormInfoDepict:function(){function a(a){var d;return a?(d=o.render(a),b.showDialog({title:"指标信息描述",content:d,dialog:{width:340,height:400,resizable:!1,buttons:[{text:"提交",click:function(){c($(this))}},{text:"取消",click:function(){$(this).dialog("close")}}]}}),void 0):(b.alert("没有指标"),void 0)}function c(a){var b=$(".data-format").find("input"),c={};b.each(function(){var a=$(this),b=a.attr("name");c[b]=a.val()}),d.model.saveNormInfoDepict(e,c,function(){a.dialog("close"),d.canvasView.showReport()})}var d=this,e=d.getActiveCompId();d.model.getNormInfoDepict(e,a)},getFilterBlankLine:function(){function a(a){var d;return a?(d=p.render(a),b.showDialog({title:"其他操作",content:d,dialog:{width:320,height:170,resizable:!1,buttons:[{text:"提交",click:function(){c($(this))}},{text:"取消",click:function(){$(this).dialog("close")}}]}}),void 0):(b.alert("没有指标"),void 0)}function c(a){var b=$(".data-format-black").find("input").eq(0),c={};c.filterBlank=b.is(":checked")?"true":"false",d.model.saveFilterBlankLine(e,c,function(){a.dialog("close"),d.canvasView.showReport()})}var d=this,e=d.getActiveCompId();d.model.getFilterBlankLine(e,a)},getActiveCompId:function(){var a=this.$conCompSetting.find(".j-comp-setting");return a.attr("data-comp-id")}})});