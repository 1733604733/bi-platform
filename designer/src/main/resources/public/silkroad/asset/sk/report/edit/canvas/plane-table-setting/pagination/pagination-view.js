define(["dialog","report/edit/canvas/plane-table-setting/pagination/pagination-model","report/edit/canvas/plane-table-setting/pagination/pagination-template"],function(a,b,c){return Backbone.View.extend({events:{"click .j-set-pagination":"getPaginationData"},initialize:function(a){this.model=new b({canvasModel:a.canvasView.model,reportId:a.reportId}),this.model.set("compId",this.$el.find(".j-comp-setting").attr("data-comp-id"))},getPaginationData:function(){var a=this;a.model.getPaginationData(function(b){a._openPaginationDialog(b)})},destroy:function(){this.stopListening(),this.model.clear({silent:!0}),delete this.model,this.$el.unbind()},_openPaginationDialog:function(b){var d,e=this;d=c.render(b),a.showDialog({title:"分页设置",content:d,dialog:{width:400,height:250,resizable:!1,buttons:[{text:"提交",click:function(){e._savePaginationInfo($(this))}},{text:"取消",click:function(){$(this).dialog("close")}}]}}),e._bindEvent()},_bindEvent:function(){var a=$(".j-isPagination"),b=$(".j-isPaginationBox .j-pageSize"),c=$(".j-notPaginationBox input");a.unbind(),a.change(function(){var a=$(this).is(":checked");a?($(".j-isPaginationBox").show(),$(".j-notPaginationBox").hide()):($(".j-isPaginationBox").hide(),$(".j-notPaginationBox").show())}),b.unbind(),b.keyup(function(a){var b=$(a.target),c=b.val().trim();return/^\d+$/.test(c)?void 0:(b.val(""),void 0)}),c.unbind(),c.keyup(function(a){var b=$(a.target),c=b.val().trim();return/^\d+$/.test(c)?void 0:(b.val(""),void 0)}),$(".j-new-pageSize").unbind(),$(".j-new-pageSize").click(function(){$(".j-pagination-error-msg").hide();var a=[],b=$(".j-pageSize").val().trim();if(!$.isPositiveInt(b))return $(".j-pagination-error-msg").html("请输入正确格式的数字").show(),void 0;for(var c=$(".j-isPaginationBox .j-pageSizeOptions"),d=[],e=c[0].options,f=0,g=e.length;g>f;f++)d.push(e[f].value);!$.isInArray(b,d)&&d.push(b),d.sort(function(a,b){return a-b});for(var f=0,g=d.length;g>f;f++){var h=' selected="selected"';a.push('<option value="',d[f],'"',b===d[f]?h:"",">",d[f],"</option>")}$(".j-pageSizeOptions").html(a.join(""))}),$(".j-reset-pageSize").unbind(),$(".j-reset-pageSize").click(function(){$(".j-pagination-error-msg").hide();for(var a=[],b=[10,50,100],c=0,d=b.length;d>c;c++)a.push('<option value="',b[c],'"',">",b[c],"</option>");$(".j-pageSizeOptions").html(a.join(""))})},_savePaginationInfo:function(a){$(".j-pagination-error-msg").hide();var b,c,d,e,f=this,g=$(".data-format-black").find(".j-isPagination").is(":checked"),h={};if(h.isPagination=g,g){b=$(".j-isPaginationBox .j-pageSizeOptions"),c=b.val().trim(),d=[],e=b[0].options;for(var i=0,j=e.length;j>i;i++)d.push(Number(e[i].value));h.pageSize=Number(c),h.pageSizeOptions=d}else{var k=$(".j-notPaginationBox input").val().trim();if(!$.isPositiveInt(k))return $(".j-pagination-error-msg").html("请输入正确格式的数字").show(),void 0;h.pageSize=Number(k)}var l={pagination:JSON.stringify(h)};f.model.savePaginationData(l,function(){a.dialog("close"),f._setPagination(h)})},_setPagination:function(a){var b,c=this,d=window.dataInsight.main.canvas,e=d.model,f=e.$reportVm,g=e.reportJson.entityDefs,h=c.model.get("compId"),i=$($(".active").children()[0]),j=f.find(".j-component-item").filter("[data-comp-id="+h+"]"),k=$(i.children()).children(),l=k[k.length-1];if(!l)return d.showReport(),void 0;b=$(l).attr("data-o_o-di");var m=b.indexOf("table-pager");if(a.isPagination){b="snpt."+h+"-vu-table-pager";var n={clzType:"VUI",clzKey:"ECUI_PAGER",id:b,compId:h,dataOpt:{pageSize:a.pageSize,pageSizeOptions:a.pageSizeOptions}};if(0>m){var o=['<div class="di-o_o-line">','<div class="" data-o_o-di="',b,'"></div>',"</div>"].join("");j.height(j.height()+22),i=$($(j).children()),i.append(o),e.reportJson.entityDefs.push(n);var p=$.getTargetElement(h,g);p.vuiRef.pager=b}else{for(var q=0,r=0,s=g.length;s>q;q++)if(g[q].id===b){r=q+1;break}r&&(e.reportJson.entityDefs=g.slice(0,r-1).concat(g.slice(r))),e.reportJson.entityDefs.push(n)}}else if(m>0){i.children()[0].remove(),j.height(j.height()-22),i=$($(j).children()),i.children()[i.children().length-1].remove(),delete $.getTargetElement(h,g).vuiRef.pager;for(var q=0,r=0,s=g.length;s>q;q++)if(g[q].id===b){r=q+1;break}r&&(e.reportJson.entityDefs=g.slice(0,r-1).concat(g.slice(r)))}d.model.saveJsonVm(function(){d.showReport()})}})});