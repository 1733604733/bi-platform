define(["template","dialog","common/float-window","report/edit/setting/derivative-ind-mgr/mgr-template","report/edit/setting/derivative-ind-mgr/mgr-model"],function(a,b,c,d,e){return Backbone.View.extend({initialize:function(){this.model=new e},openDialog:function(){for(var a,c=this,e=window.dataInsight.main.model.get("indList"),f=!1,g=0,h=e.data.length;h>g;g++)if("CAL"===e.data[g].type){f=!0;break}a=d.render({indList:e,hasDerive:f}),b.showDialog({dialog:{height:405,width:600,resizable:!1,open:function(){c.el=$(this),$(this).on("focusin",".j-value",function(a){c.focusInput=a.target}),$(this).on("click",".area-inds-item",function(){c.focusInput=$(this)[0],$(this).find("input").focus()}),$(this).on("click",".j-delete",function(a){b.confirm("确定删除吗？",function(){var b=$(a.target).parent().parent().find(".j-input-datasource-address").attr("id");b?c.model.deleteInd(b,function(){$(a.target).parents(".j-derive-item").remove()}):$(a.target).parents(".j-derive-item").remove()})}),$(".j-ori-item",$(this)).click(function(a){c._clickOriItem.call(c,a)}),$(".j-add-derive",$(this)).click(function(a){c._addDerive.call(c,a)}),$(this).on("click",".j-classification",function(a){c._tabClick(a)}),$(this).on("click",".area-inds-item-ind-delete",function(a){c._deleteSrRrInd($(a.target))})},buttons:{"提交":function(){var a=$(this);c._submitMethodTypeValue(a,function(){a.dialog("close")})},"取消":function(){var a=$(this);c.model.updateLeftPanel(function(){a.dialog("close")})}}},content:a,title:"衍生指标管理"})},destroy:function(){this.model.clear({silent:!0}),delete this.model},_submitMethodTypeValue:function(a,b){var c=this,d={extendInds:{}};d.calDeriveInds=this._getDeriveData(a),d.extendInds.rr=this._getSrRrData(1,a),d.extendInds.sr=this._getSrRrData(2,a),c.model.submitMethodTypeValue(d,b)},_addDerive:function(a){var b=$(a.target).parent(),c=$(".j-derive-item-template",this.el).clone();c.removeClass("hide j-derive-item-template").addClass("j-derive-item"),b.before(c)},_clickOriItem:function(a){var b=$(a.target),c=b.attr("data-input"),d=$(this.focusInput);if(d.hasClass("j-area-inds-item-sr")||d.hasClass("j-area-inds-item-rr")){d.hasClass("j-area-inds-item-sr")&&(c+="_sr"),d.hasClass("j-area-inds-item-rr")&&(c+="_rr");var e=!1,f=['<div class="area-inds-item-ind j-area-inds-item-ind f-l" title="',c,'">',c,'<span class="hide area-inds-item-ind-delete">x</span>',"</div>"].join("");if(d.find(".j-area-inds-item-ind").each(function(){e=$(this).attr("title")===c?!0:!1}),e)return;d.find("input").before(f).focus()}else void 0!==this.focusInput&&d.val(d.val()+"${"+c+"}")},_deleteSrRrInd:function(a){var c=this;b.confirm("确定删除吗？",function(){var b=a.parent().attr("id");b?c.model.deleteInd(b,function(){a.parent().remove()}):a.parent().remove()})},_getDeriveData:function(a){var b=[];return a.find(".j-derive-item").each(function(){var a=$(this).find("input"),c=a.eq(0),d={id:c.attr("id")||"",name:"",caption:c.val(),formula:a.eq(1).val()};b.push(d)}),b},_getSrRrData:function(a,b){var c=[],d=1==a?" .j-area-inds-item-rr":" .j-area-inds-item-sr",e=".j-data-sources-derive-list-select"+d+" .j-area-inds-item-ind",f=b.find(e);return f.each(function(){c.push({id:$(this).attr("id")||"",name:$(this).attr("name")||$(this).attr("title"),caption:$(this).attr("title")})}),c},_tabClick:function(a){var b,c,d;"span"===a.target.tagName.toLowerCase()?b=$(a.target).parent():"li"===a.target.tagName.toLowerCase()&&(b=$(a.target)),b.addClass("classification-focus").siblings().removeClass("classification-focus"),c=b.attr("id"),d=c.split("-"),$(".description-"+d[d.length-1]).show().siblings().hide(),$(".data-sources-derive-list-"+d[d.length-1]).show().siblings().hide()}})});